<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stock Surveillance Data Viewer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .calendar-wrapper {
    margin-top: 1rem;
  }
  .calendar-month {
    margin-bottom: 2rem;
  }
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
  }
  .calendar-day {
    border: 1px solid #dee2e6;
    padding: 0.5rem;
    min-height: 80px;
    position: relative;
  }
  .calendar-date {
    font-weight: bold;
    margin-bottom: 5px;
  }
  .calendar-weekday {
    text-align: center;
    font-weight: bold;
    padding: 0.5rem;
    background-color: #f8f9fa;
  }
  .calendar-day.weekend {
    background-color: #f8f9fa;
  }
  .calendar-day.has-data {
    cursor: pointer;
  }
  .calendar-day.has-data:hover {
    background-color: #e9ecef;
  }
  .indicator-value {
    font-size: 0.9rem;
  }
  .value-high {
    color: green;
  }
  .value-medium {
    color: orange;
  }
  .value-low {
    color: red;
  }
    body { padding: 2rem; }
    .form-section { margin-bottom: 1.5rem; }
    .indicator-container {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 0.25rem;
      padding: 0.5rem;
    }
    .indicator-item {
      margin-bottom: 0.5rem;
    }
    .loading {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 0.2em solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: spinner-border .75s linear infinite;
      margin-left: 0.5rem;
    }
    @keyframes spinner-border {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4">Stock Surveillance Data Viewer</h2>

    <form id="stockForm">
      <!-- Exchange Selection -->
      <div class="form-section">
        <label for="exchange" class="form-label">Select Exchange</label>
        <select class="form-select" id="exchange" required>
          <option value="">-- Select --</option>
          <option value="NSE">NSE</option>
          <option value="BSE">BSE</option>
        </select>
      </div>

      <!-- Date Picker (Calendar) -->
      <div class="form-section">
        <label for="date" class="form-label">Select Date</label>
        <input type="date" class="form-control" id="date" required>
        <small class="text-muted" id="dateAvailability"></small>
      </div>

      <!-- Stock Auto-suggest -->
      <div class="form-section">
        <label for="stock" class="form-label">Stock Name/Symbol</label>
        <input list="stockList" class="form-control" id="stock" placeholder="Type stock name..." required>
        <datalist id="stockList">
          <!-- Populated dynamically -->
        </datalist>
        <small class="text-muted">Available stocks will load after selecting date</small>
      </div>

      <!-- Indicator Selection -->
      <div class="form-section">
        <label class="form-label">Choose Indicators</label>
        <div class="indicator-container" id="indicatorsContainer">
          <div class="text-center p-3">Please select an exchange and date first</div>
        </div>
      </div>

      <!-- Summary -->
      <div class="form-section">
        <label class="form-label">Selected Indicators:</label>
        <div id="summary" class="p-2 bg-light rounded">
          <em>No indicators selected</em>
        </div>
      </div>

      <!-- Submit -->
      <button type="submit" class="btn btn-primary">View Data</button>
    </form>

    <!-- Output -->
    <div id="output" class="mt-4"></div>
    <div class="mt-4 mb-3">
  <h3>Historical View</h3>
  <div class="row">
    <div class="col-md-6">
      <div class="form-section">
        <label for="histStock" class="form-label">Stock for Historical View</label>
        <input list="stockList" class="form-control" id="histStock" placeholder="Enter stock name/symbol">
      </div>
    </div>
    <div class="col-md-3">
      <div class="form-section">
        <label for="histIndicator" class="form-label">Select Indicator</label>
        <select class="form-select" id="histIndicator">
          <option value="">-- Select --</option>
        </select>
      </div>
    </div>
    <div class="col-md-3">
      <div class="form-section">
        <label for="histExchange" class="form-label">Exchange</label>
        <select class="form-select" id="histExchange">
          <option value="">-- Select --</option>
          <option value="NSE">NSE</option>
          <option value="BSE">BSE</option>
        </select>
      </div>
    </div>
  </div>
  <button id="viewHistorical" class="btn btn-success">View Historical Data</button>
</div>

<!-- Add calendar view container -->
<div id="calendarView" class="mt-4"></div>
  </div>

 <!-- // Add this HTML section to your page (as a new section) -->
<div class="mt-5 pt-3 border-top">
  <h2 class="mb-4">Indicator-Based Analysis</h2>
  
  <div class="row">
    <div class="col-md-6">
      <div class="form-section">
        <label for="indicatorExchange" class="form-label">Select Exchange</label>
        <select class="form-select" id="indicatorExchange">
          <option value="">-- Select --</option>
          <option value="NSE">NSE</option>
          <option value="BSE">BSE</option>
        </select>
      </div>
    </div>
    <div class="col-md-6">
      <div class="form-section">
        <label for="indicatorDate" class="form-label">Select Date</label>
        <input type="date" class="form-control" id="indicatorDate">
      </div>
    </div>
  </div>
  
  <div class="form-section">
    <label for="indicatorSelect" class="form-label">Select Indicators</label>
    <select class="form-select" id="indicatorSelect" multiple size="8">
      <!-- Will be populated dynamically -->
    </select>
    <small class="text-muted">Hold Ctrl/Cmd to select multiple indicators</small>
  </div>
  
  <div class="d-flex gap-2 mb-4">
    <button id="viewIndicatorData" class="btn btn-primary">View Data</button>
    <button id="viewIndicatorHistory" class="btn btn-success">View Historical Calendar</button>
  </div>
  
  <!-- Outputs -->
  <div id="indicatorDataOutput" class="mt-3"></div>
  <div id="indicatorHistoryOutput" class="mt-3"></div>
</div>

  <script>
    // Global state
    const state = {
      indexFiles: {
        nse: [],
        bse: []
      },
      stocks: [],
      indicators: [],
      dateFileMap: {},
      availableDates: new Set()
    };

    // Add these DOM elements to your existing declarations
const indicatorExchangeSelect = document.getElementById('indicatorExchange');
const indicatorDateInput = document.getElementById('indicatorDate');
const indicatorSelect = document.getElementById('indicatorSelect');
const viewIndicatorDataBtn = document.getElementById('viewIndicatorData');
const viewIndicatorHistoryBtn = document.getElementById('viewIndicatorHistory');
const indicatorDataOutputDiv = document.getElementById('indicatorDataOutput');
const indicatorHistoryOutputDiv = document.getElementById('indicatorHistoryOutput');

// Global state additions
state.indicatorHistoricalData = {};

// Handle exchange selection for indicator analysis
indicatorExchangeSelect.addEventListener('change', async () => {
  const exchange = indicatorExchangeSelect.value.toLowerCase();
  if (!exchange) return;
  
  indicatorDateInput.disabled = true;
  indicatorDateInput.value = '';
  indicatorSelect.innerHTML = '';
  
  try {
    // Load index file based on exchange (reuse existing logic)
    const indexFileName = exchange === 'nse' ? 'nse_json/index.json' : 'bse_json/index_bse.json';
    const response = await fetch(indexFileName);
    
    if (!response.ok) {
      throw new Error(`Failed to load index file for ${exchange.toUpperCase()}`);
    }
    
    const indexData = await response.json();
    state.indexFiles[exchange] = indexData;
    
    // Store available dates
    populateAvailableDates(indexData);
    indicatorDateInput.disabled = false;
  } catch (error) {
    console.error(error);
  }
});

// Populate available dates
function populateAvailableDates(indexFiles) {
  // Clear existing date
  indicatorDateInput.value = '';
  
  // Store available dates
  state.availableDates = new Set();
  
  indexFiles.forEach(filePath => {
    // Extract date from filename (IND150525.json â†’ 15/05/25)
    const match = filePath.match(/IND(\d{2})(\d{2})(\d{2})\.json/);
    if (match) {
      const day = match[1];
      const month = match[2];
      const year = `20${match[3]}`;
      const dateStr = `${year}-${month}-${day}`;
      
      // Store mapping of formatted date to filename
      state.dateFileMap[dateStr] = filePath;
      state.availableDates.add(dateStr);
    }
  });
}

// Load indicators when date is selected for indicator analysis
indicatorDateInput.addEventListener('change', async () => {
  const date = indicatorDateInput.value;
  const exchange = indicatorExchangeSelect.value.toLowerCase();
  
  if (!date || !exchange) return;
  
  indicatorSelect.innerHTML = '<option>Loading indicators...</option>';
  
  try {
    const filePath = state.dateFileMap[date];
    if (!filePath) throw new Error('File path not found for selected date');
    
    const response = await fetch(filePath);
    if (!response.ok) throw new Error('Failed to load data file');
    
    const data = await response.json();
    
    // Load available indicators
    loadAvailableIndicators(data);
  } catch (error) {
    indicatorSelect.innerHTML = '<option>Error loading indicators</option>';
    console.error(error);
  }
});

// Load available indicators for dropdown
function loadAvailableIndicators(data) {
  indicatorSelect.innerHTML = '';
  
  // Find indicator fields
  let sampleData;
  if (Array.isArray(data)) {
    sampleData = data[0];
  } else {
    sampleData = data;
  }
  
  const startIndex = Object.keys(sampleData).indexOf('GSM');
  if (startIndex === -1) {
    indicatorSelect.innerHTML = '<option>No indicators found</option>';
    return;
  }
  
  const fields = Object.keys(sampleData);
  state.indicators = fields.slice(startIndex).filter(ind => ind !== '' && !ind.startsWith('Filler'));
  
  // Add indicators to dropdown
  state.indicators.forEach(indicator => {
    const option = document.createElement('option');
    option.value = indicator;
    option.textContent = indicator;
    indicatorSelect.appendChild(option);
  });
}

// View indicator data button click
viewIndicatorDataBtn.addEventListener('click', async () => {
  const date = indicatorDateInput.value;
  const exchange = indicatorExchangeSelect.value.toLowerCase();
  const selectedIndicators = Array.from(indicatorSelect.selectedOptions).map(opt => opt.value);
  
  if (!date || !exchange || selectedIndicators.length === 0) {
    indicatorDataOutputDiv.innerHTML = '<div class="alert alert-warning">Please select exchange, date and at least one indicator</div>';
    return;
  }
  
  indicatorDataOutputDiv.innerHTML = '<div class="alert alert-info">Loading data... <span class="loading"></span></div>';
  
  try {
    const filePath = state.dateFileMap[date];
    const response = await fetch(filePath);
    if (!response.ok) throw new Error('Failed to load data file');
    
    const data = await response.json();
    
    // Display indicator data for all stocks
    displayIndicatorData(data, selectedIndicators, date, exchange);
  } catch (error) {
    indicatorDataOutputDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    console.error(error);
  }
});

// Display indicator data for all stocks
// Add this function to count row types (add to global scope)
function countRowTypes(data, selectedIndicator) {
  const counts = {
    all: data.length,
    na: 0,
    zero: 0,
    other: 0
  };
  
  data.forEach(item => {
    const value = item[selectedIndicator];
    if (value === '100') {
      counts.na++;
    } else if (value === '0') {
      counts.zero++;
    } else {
      counts.other++;
    }
  });
  
  return counts;
}

// Replace the existing displayIndicatorData function with this one
function displayIndicatorData(data, selectedIndicators, date, exchange) {
  const stocksData = Array.isArray(data) ? data : [data];
  const key = exchange === 'nse' ? 'Symbol' : 'ScripId';
  
  // Calculate counts for first selected indicator
  const counts = countRowTypes(stocksData, selectedIndicators[0]);
  
  let html = `
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0">Indicator Data for ${formatDisplayDate(date)} (${exchange.toUpperCase()})</h4>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <div class="btn-group" role="group" aria-label="Filter options">
            <button type="button" class="btn btn-outline-primary filter-btn active" data-filter="all">All Values (${counts.all})</button>
            <button type="button" class="btn btn-outline-success filter-btn" data-filter="na">Not Applicable (${counts.na})</button>
            <button type="button" class="btn btn-outline-danger filter-btn" data-filter="zero">Zero Values (${counts.zero})</button>
            <button type="button" class="btn btn-outline-warning filter-btn" data-filter="other">Other Values (${counts.other})</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-striped table-sm" id="indicatorTable">
            <thead class="table-dark">
              <tr>
                <th>Stock</th>
                ${selectedIndicators.map(ind => `<th>${ind}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
  `;
  
  // Add data for each stock
  stocksData.forEach(stock => {
    // Determine row type for filtering
    let rowType = 'other';
    const firstIndicator = selectedIndicators[0]; // Use first selected indicator for row filtering
    const firstValue = stock[firstIndicator] || '-';
    
    if (firstValue === '100') {
      rowType = 'na';
    } else if (firstValue === '0') {
      rowType = 'zero';
    }
    
    html += `
      <tr class="filter-row" data-filter-type="${rowType}">
        <td>${stock[key] || 'Unknown'}</td>
    `;
    
    // Add selected indicators for this stock
    selectedIndicators.forEach(indicator => {
      const value = stock[indicator] || '-';
      let valueClass = '';
      let displayValue = value;
      
      // Add color coding and "Not Applicable" text for 100 values
      if (!isNaN(value)) {
        if (value === '0') {
          valueClass = 'bg-danger text-white';
        } else if (value === '100') {
          valueClass = 'bg-success text-white';
          displayValue = `${value} (Not Applicable)`;
        }
      }
      
      html += `<td class="${valueClass}">${displayValue}</td>`;
    });
    
    html += '</tr>';
  });
  
  html += `
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
  
  indicatorDataOutputDiv.innerHTML = html;
  
  // Add filter functionality
  setTimeout(() => {
    const filterButtons = document.querySelectorAll('.filter-btn');
    const rows = document.querySelectorAll('.filter-row');
    
    filterButtons.forEach(button => {
      button.addEventListener('click', () => {
        // Update active button
        filterButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        
        const filterType = button.getAttribute('data-filter');
        
        // Show/hide rows based on filter
        rows.forEach(row => {
          if (filterType === 'all') {
            row.style.display = '';
          } else {
            const rowType = row.getAttribute('data-filter-type');
            row.style.display = (rowType === filterType) ? '' : 'none';
          }
        });
      });
    });
  }, 100);
}
// View indicator history button click
viewIndicatorHistoryBtn.addEventListener('click', async () => {
  const exchange = indicatorExchangeSelect.value.toLowerCase();
  const selectedIndicators = Array.from(indicatorSelect.selectedOptions).map(opt => opt.value);
  
  if (!exchange || selectedIndicators.length === 0) {
    indicatorHistoryOutputDiv.innerHTML = '<div class="alert alert-warning">Please select exchange and at least one indicator</div>';
    return;
  }
  
  // Limit to one indicator for historical view
  const indicator = selectedIndicators[0];
  
  indicatorHistoryOutputDiv.innerHTML = '<div class="alert alert-info">Loading historical data... <span class="loading"></span></div>';
  
  try {
    await fetchIndicatorHistoricalData(indicator, exchange);
    renderIndicatorCalendarView(indicator, exchange);
  } catch (error) {
    indicatorHistoryOutputDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    console.error(error);
  }
});

// Fetch historical data for an indicator regardless of stock
async function fetchIndicatorHistoricalData(indicator, exchange) {
  const files = state.indexFiles[exchange];
  if (!files || files.length === 0) {
    throw new Error(`No data files found for ${exchange.toUpperCase()}`);
  }
  
  // Create unique key for caching
  const cacheKey = `${exchange}_all_${indicator}`;
  
  // Check if we already have this data cached
  if (state.indicatorHistoricalData[cacheKey]) {
    return state.indicatorHistoricalData[cacheKey];
  }
  
  const data = {};
  
  // Process each file (date) sequentially
  for (const filePath of files) {
    try {
      const response = await fetch(filePath);
      if (!response.ok) continue;
      
      const fileData = await response.json();
      
      // Extract date from filename (IND150525.json â†’ 2025-05-15)
      const match = filePath.match(/IND(\d{2})(\d{2})(\d{2})\.json/);
      if (!match) continue;
      
      const day = match[1];
      const month = match[2];
      const year = `20${match[3]}`;
      const dateStr = `${year}-${month}-${day}`;
      
      // Calculate average indicator value across all stocks
      const key = exchange === 'nse' ? 'Symbol' : 'ScripId';
      let stocks = Array.isArray(fileData) ? fileData : [fileData];
      
      // Filter out entries with no value for the indicator
      const stocksWithIndicator = stocks.filter(stock => stock[indicator] !== undefined);
      
      if (stocksWithIndicator.length > 0) {
        // Calculate stats
        const values = stocksWithIndicator.map(stock => parseFloat(stock[indicator]) || 0);
        const sum = values.reduce((a, b) => a + b, 0);
        const avg = (sum / values.length).toFixed(2);
        const count = values.length;
        const countWithValue100 = values.filter(val => val === 100).length;
        
        data[dateStr] = {
          avg: avg,
          count: count,
          countWithValue100: countWithValue100
        };
      }
    } catch (error) {
      console.warn(`Error loading data from ${filePath}:`, error);
      // Continue to next file
    }
  }
  
  // Cache the results
  state.indicatorHistoricalData[cacheKey] = data;
  return data;
}

// Render calendar view for indicator historical data
function renderIndicatorCalendarView(indicator, exchange) {
  const cacheKey = `${exchange}_all_${indicator}`;
  const data = state.indicatorHistoricalData[cacheKey] || {};
  
  if (Object.keys(data).length === 0) {
    indicatorHistoryOutputDiv.innerHTML = '<div class="alert alert-warning">No historical data found for the selected indicator</div>';
    return;
  }
  
  // Group dates by month
  const months = {};
  for (const dateStr in data) {
    const date = new Date(dateStr);
    const monthYear = `${date.getMonth() + 1}-${date.getFullYear()}`;
    
    if (!months[monthYear]) {
      months[monthYear] = [];
    }
    
    months[monthYear].push({
      date: date,
      data: data[dateStr]
    });
  }
  
  // Sort months
  const sortedMonths = Object.keys(months).sort((a, b) => {
    const [monthA, yearA] = a.split('-').map(Number);
    const [monthB, yearB] = b.split('-').map(Number);
    
    if (yearA !== yearB) return yearA - yearB;
    return monthA - monthB;
  });
  
  // Build calendar HTML
  let html = `
    <div class="card">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0">Historical Data: ${indicator} (${exchange.toUpperCase()}) - All Stocks</h4>
      </div>
      <div class="card-body calendar-wrapper">
  `;
  
  // Add each month
  sortedMonths.forEach(monthKey => {
    const [month, year] = monthKey.split('-').map(Number);
    const monthDate = new Date(year, month - 1, 1);
    const monthName = monthDate.toLocaleString('default', { month: 'long' });
    
    html += `
      <div class="calendar-month">
        <h5>${monthName} ${year}</h5>
        <div class="calendar-grid">
          <div class="calendar-weekday">Sun</div>
          <div class="calendar-weekday">Mon</div>
          <div class="calendar-weekday">Tue</div>
          <div class="calendar-weekday">Wed</div>
          <div class="calendar-weekday">Thu</div>
          <div class="calendar-weekday">Fri</div>
          <div class="calendar-weekday">Sat</div>
    `;
    
    const firstDay = new Date(year, month - 1, 1).getDay();
    const lastDate = new Date(year, month, 0).getDate();
    
    // Add empty cells for days before first day of month
    for (let i = 0; i < firstDay; i++) {
      html += '<div class="calendar-day"></div>';
    }
    
    // Add days of the month
    for (let day = 1; day <= lastDate; day++) {
      const date = new Date(year, month - 1, day);
      const dateStr = date.toISOString().split('T')[0];
      const weekday = date.getDay();
      const isWeekend = weekday === 0 || weekday === 6;
      
      const dayData = months[monthKey].find(d => 
        d.date.getDate() === day &&
        d.date.getMonth() === month - 1 &&
        d.date.getFullYear() === year
      );
      
      const hasData = !!dayData;
      let valueClass = '';
      
      if (hasData) {
        const value = Number(dayData.data.avg);
        if (!isNaN(value)) {
          if (value >= 80) valueClass = 'value-high';
          else if (value >= 50) valueClass = 'value-medium';
          else valueClass = 'value-low';
        }
      }
      
      html += `
        <div class="calendar-day ${isWeekend ? 'weekend' : ''} ${hasData ? 'has-data' : ''}" 
             data-date="${dateStr}">
          <div class="calendar-date">${day}</div>
          ${hasData ? `
            <div class="indicator-value ${valueClass}">
              Avg: ${dayData.data.avg}${Number(dayData.data.avg) === 100 ? ' (N/A)' : ''}
            </div>
            <div class="small">Stocks: ${dayData.data.count}</div>
            <div class="small">100's: ${dayData.data.countWithValue100}</div>
          ` : ''}
        </div>
      `;
    }
    
    html += `
        </div>
      </div>
    `;
  });
  
  html += `
      </div>
    </div>
  `;
  
  indicatorHistoryOutputDiv.innerHTML = html;
}

    // DOM elements
    const exchangeSelect = document.getElementById('exchange');
    const dateSelect = document.getElementById('date');
    const stockInput = document.getElementById('stock');
    const stockList = document.getElementById('stockList');
    const indicatorsContainer = document.getElementById('indicatorsContainer');
    const summaryDiv = document.getElementById('summary');
    const outputDiv = document.getElementById('output');
    const form = document.getElementById('stockForm');
    // Add these to your existing DOM elements
    const histStockInput = document.getElementById('histStock');
    const histIndicatorSelect = document.getElementById('histIndicator');
    const histExchangeSelect = document.getElementById('histExchange');
    const viewHistoricalBtn = document.getElementById('viewHistorical');
    const calendarViewDiv = document.getElementById('calendarView');
    
    // Global state additions
    state.historicalData = {};

    // Load index files when exchange is selected
    exchangeSelect.addEventListener('change', async () => {
      const exchange = exchangeSelect.value.toLowerCase();
      if (!exchange) return;
      
      dateSelect.innerHTML = '<option value="">-- Loading dates... --</option>';
      
      try {
        // Load index file based on exchange
        const indexFileName = exchange === 'nse' ? 'nse_json/index.json' : 'bse_json/index_bse.json';
        const response = await fetch(indexFileName);
        
        if (!response.ok) {
          throw new Error(`Failed to load index file for ${exchange.toUpperCase()}`);
        }
        
        const indexData = await response.json();
        state.indexFiles[exchange] = indexData;
        
        // Extract and format dates
        populateDates(exchange, indexData);
      } catch (error) {
        dateSelect.innerHTML = '<option value="">-- Error loading dates --</option>';
        console.error(error);
      }
    });

    // Extract dates from filenames and populate date dropdown
    function populateDates(exchange, indexFiles) {
      dateSelect.innerHTML = '<option value="">-- Select Date --</option>';
      
      indexFiles.forEach(filePath => {
        // Extract date from filename (IND150525.json â†’ 15/05/25)
        const match = filePath.match(/IND(\d{2})(\d{2})(\d{2})\.json/);
        if (match) {
          const day = match[1];
          const month = match[2];
          const year = `20${match[3]}`;
          const dateStr = `${year}-${month}-${day}`;
          const displayDate = `${day}/${month}/${year}`;
          
          // Store mapping of formatted date to filename
          state.dateFileMap[dateStr] = filePath;
          
          const option = document.createElement('option');
          option.value = dateStr;
          option.textContent = displayDate;
          dateSelect.appendChild(option);
        }
      });
    }

    // Load stocks and indicators when date is selected
    dateSelect.addEventListener('change', async () => {
      const date = dateSelect.value;
      const exchange = exchangeSelect.value.toLowerCase();
      
      if (!date || !exchange) return;
      
      stockInput.value = '';
      indicatorsContainer.innerHTML = '<div class="text-center p-3">Loading indicators...</div>';
      
      try {
        const filePath = state.dateFileMap[date];
        if (!filePath) throw new Error('File path not found for selected date');
        
        const response = await fetch(filePath);
        if (!response.ok) throw new Error('Failed to load data file');
        
        const data = await response.json();
        
        // Extract stocks and indicators
        loadStocksAndIndicators(exchange, data);
      } catch (error) {
        indicatorsContainer.innerHTML = `<div class="text-danger p-3">Error: ${error.message}</div>`;
        console.error(error);
      }
    });

    // Load stocks and indicators from data
    function loadStocksAndIndicators(exchange, data) {
      stockList.innerHTML = '';
      state.stocks = [];
      
      // Get stock symbols from data
      if (Array.isArray(data)) {
        const key = exchange === 'nse' ? 'Symbol' : 'ScripId';
        
        // Extract unique stock symbols
        const stockSet = new Set(data.map(item => item[key]).filter(Boolean));
        state.stocks = Array.from(stockSet);
        
        // Get indicators from first item
        if (data.length > 0) {
          loadIndicators(data[0]);
        }
      } else {
        // Single item in data
        const key = exchange === 'nse' ? 'Symbol' : 'ScripId';
        if (data[key]) {
          state.stocks.push(data[key]);
        }
        loadIndicators(data);
      }
      
      // Populate stock suggestions
      state.stocks.sort().forEach(stock => {
        const option = document.createElement('option');
        option.value = stock;
        stockList.appendChild(option);
      });
    }

    // Load indicators as checkboxes
    // Replace your existing loadIndicators function with this updated version
function loadIndicators(sampleData) {
  indicatorsContainer.innerHTML = '';
  histIndicatorSelect.innerHTML = '<option value="">-- Select --</option>';
  
  // Find indicator fields (most start after "GSM")
  const startIndex = Object.keys(sampleData).indexOf('GSM');
  if (startIndex === -1) {
    indicatorsContainer.innerHTML = '<div class="text-danger p-3">No indicators found in data</div>';
    return;
  }
  
  const fields = Object.keys(sampleData);
  state.indicators = fields.slice(startIndex);
  
  // Create checkboxes for indicators
  state.indicators.forEach(indicator => {
    if (indicator === '' || indicator.startsWith('Filler')) return;
    
    // Add to indicators container
    const div = document.createElement('div');
    div.className = 'indicator-item';
    
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.className = 'form-check-input me-2';
    checkbox.id = `ind-${indicator}`;
    checkbox.value = indicator;
    checkbox.name = 'indicators';
    
    const label = document.createElement('label');
    label.className = 'form-check-label';
    label.htmlFor = `ind-${indicator}`;
    label.textContent = indicator;
    
    checkbox.addEventListener('change', updateSummary);
    
    div.appendChild(checkbox);
    div.appendChild(label);
    indicatorsContainer.appendChild(div);
    
    // Add to historical indicator dropdown
    const option = document.createElement('option');
    option.value = indicator;
    option.textContent = indicator;
    histIndicatorSelect.appendChild(option);
  });
}    

      // Historical view button event listener
  viewHistoricalBtn.addEventListener('click', async () => {
    const stock = histStockInput.value.trim();
    const indicator = histIndicatorSelect.value;
    const exchange = histExchangeSelect.value.toLowerCase();
    
    if (!stock || !indicator || !exchange) {
      calendarViewDiv.innerHTML = '<div class="alert alert-warning">Please select stock, indicator and exchange</div>';
      return;
    }
    
    calendarViewDiv.innerHTML = '<div class="alert alert-info">Loading historical data... <span class="loading"></span></div>';
    
    try {
      await fetchHistoricalData(stock, indicator, exchange);
      renderCalendarView(stock, indicator, exchange);
    } catch (error) {
      calendarViewDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
      console.error(error);
    }
  });
  
  // Fetch historical data for a stock and indicator
  async function fetchHistoricalData(stock, indicator, exchange) {
    const files = state.indexFiles[exchange];
    if (!files || files.length === 0) {
      throw new Error(`No data files found for ${exchange.toUpperCase()}`);
    }
    
    // Create unique key for caching
    const cacheKey = `${exchange}_${stock}_${indicator}`;
    
    // Check if we already have this data cached
    if (state.historicalData[cacheKey]) {
      return state.historicalData[cacheKey];
    }
    
    const data = {};
    
    // Process each file (date) sequentially
    for (const filePath of files) {
      try {
        const response = await fetch(filePath);
        if (!response.ok) continue;
        
        const fileData = await response.json();
        
        // Extract date from filename (IND150525.json â†’ 2025-05-15)
        const match = filePath.match(/IND(\d{2})(\d{2})(\d{2})\.json/);
        if (!match) continue;
        
        const day = match[1];
        const month = match[2];
        const year = `20${match[3]}`;
        const dateStr = `${year}-${month}-${day}`;
        
        // Find stock data
        const key = exchange === 'nse' ? 'Symbol' : 'ScripId';
        let stockData;
        
        if (Array.isArray(fileData)) {
          stockData = fileData.find(item => item[key] === stock);
        } else if (fileData[key] === stock) {
          stockData = fileData;
        }
        
        // Store indicator value if found
        if (stockData && indicator in stockData) {
          data[dateStr] = stockData[indicator];
        }
      } catch (error) {
        console.warn(`Error loading data from ${filePath}:`, error);
        // Continue to next file
      }
    }
    
    // Cache the results
    state.historicalData[cacheKey] = data;
    return data;
  }
  
  // Render calendar view
  function renderCalendarView(stock, indicator, exchange) {
    const cacheKey = `${exchange}_${stock}_${indicator}`;
    const data = state.historicalData[cacheKey] || {};
    
    if (Object.keys(data).length === 0) {
      calendarViewDiv.innerHTML = '<div class="alert alert-warning">No historical data found for the selected criteria</div>';
      return;
    }
    
    // Group dates by month
    const months = {};
    for (const dateStr in data) {
      const date = new Date(dateStr);
      const monthYear = `${date.getMonth() + 1}-${date.getFullYear()}`;
      
      if (!months[monthYear]) {
        months[monthYear] = [];
      }
      
      months[monthYear].push({
        date: date,
        value: data[dateStr]
      });
    }
    
    // Sort months
    const sortedMonths = Object.keys(months).sort((a, b) => {
      const [monthA, yearA] = a.split('-').map(Number);
      const [monthB, yearB] = b.split('-').map(Number);
      
      if (yearA !== yearB) return yearA - yearB;
      return monthA - monthB;
    });
    
    // Build calendar HTML
    let html = `
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">Historical Data: ${indicator} for ${stock} (${exchange.toUpperCase()})</h4>
        </div>
        <div class="card-body calendar-wrapper">
    `;
    
    // Add each month
    sortedMonths.forEach(monthKey => {
      const [month, year] = monthKey.split('-').map(Number);
      const monthDate = new Date(year, month - 1, 1);
      const monthName = monthDate.toLocaleString('default', { month: 'long' });
      
      html += `
        <div class="calendar-month">
          <h5>${monthName} ${year}</h5>
          <div class="calendar-grid">
            <div class="calendar-weekday">Sun</div>
            <div class="calendar-weekday">Mon</div>
            <div class="calendar-weekday">Tue</div>
            <div class="calendar-weekday">Wed</div>
            <div class="calendar-weekday">Thu</div>
            <div class="calendar-weekday">Fri</div>
            <div class="calendar-weekday">Sat</div>
      `;
      
      const firstDay = new Date(year, month - 1, 1).getDay();
      const lastDate = new Date(year, month, 0).getDate();
      
      // Add empty cells for days before first day of month
      for (let i = 0; i < firstDay; i++) {
        html += '<div class="calendar-day"></div>';
      }
      
      // Add days of the month
      for (let day = 1; day <= lastDate; day++) {
        const date = new Date(year, month - 1, day);
        const dateStr = date.toISOString().split('T')[0];
        const weekday = date.getDay();
        const isWeekend = weekday === 0 || weekday === 6;
        
        const dayData = months[monthKey].find(d => 
          d.date.getDate() === day &&
          d.date.getMonth() === month - 1 &&
          d.date.getFullYear() === year
        );
        
        const hasData = !!dayData;
        let valueClass = '';
        
        if (hasData) {
          const value = Number(dayData.value);
          if (!isNaN(value)) {
            if (value >= 80) valueClass = 'value-high';
            else if (value >= 50) valueClass = 'value-medium';
            else valueClass = 'value-low';
          }
        }
        
        html += `
          <div class="calendar-day ${isWeekend ? 'weekend' : ''} ${hasData ? 'has-data' : ''}" 
               data-date="${dateStr}">
            <div class="calendar-date">${day}</div>
            ${hasData ? `<div class="indicator-value ${valueClass}">${dayData.value}</div>` : ''}
          </div>
        `;
      }
      
      html += `
          </div>
        </div>
      `;
    });
    
    html += `
        </div>
      </div>
    `;
    
    calendarViewDiv.innerHTML = html;
    
    // Add click handlers to days with data
    document.querySelectorAll('.calendar-day.has-data').forEach(day => {
      day.addEventListener('click', () => {
        const date = day.getAttribute('data-date');
        const dateObj = new Date(date);
        
        // Format date for display
        dateSelect.value = date;
        
        // Trigger date change to load stock data
        const event = new Event('change');
        dateSelect.dispatchEvent(event);
        
        // Set stock input value
        setTimeout(() => {
          stockInput.value = stock;
          
          // Check the indicator checkbox
          const indicatorCheckbox = document.getElementById(`ind-${indicator}`);
          if (indicatorCheckbox) {
            indicatorCheckbox.checked = true;
            // Trigger change to update summary
            indicatorCheckbox.dispatchEvent(new Event('change'));
          }
          
          // Scroll to form
          form.scrollIntoView({ behavior: 'smooth' });
        }, 500);
      });
    });
  }

    // Update summary of selected indicators
    function updateSummary() {
      const selectedIndicators = Array.from(
        document.querySelectorAll('input[name="indicators"]:checked')
      ).map(cb => cb.value);
      
      if (selectedIndicators.length === 0) {
        summaryDiv.innerHTML = '<em>No indicators selected</em>';
        return;
      }
      
      summaryDiv.innerHTML = '';
      selectedIndicators.forEach(ind => {
        const badge = document.createElement('span');
        badge.className = 'badge bg-primary me-2 mb-2';
        badge.textContent = ind;
        summaryDiv.appendChild(badge);
      });
    }

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const exchange = exchangeSelect.value;
      const date = dateSelect.value;
      const stockName = stockInput.value.trim();
      const selectedIndicators = Array.from(
        document.querySelectorAll('input[name="indicators"]:checked')
      ).map(cb => cb.value);
      
      if (!exchange || !date || !stockName || selectedIndicators.length === 0) {
        outputDiv.innerHTML = '<div class="alert alert-warning">Please fill all fields and select at least one indicator</div>';
        return;
      }
      
      // Check if selected date has data
      if (!state.dateFileMap[date]) {
        outputDiv.innerHTML = '<div class="alert alert-warning">No data available for the selected date</div>';
        return;
      }
      
      outputDiv.innerHTML = '<div class="alert alert-info">Loading data... <span class="loading"></span></div>';
      
      try {
        const filePath = state.dateFileMap[date];
        const response = await fetch(filePath);
        if (!response.ok) throw new Error('Failed to load data file');
        
        const data = await response.json();
        const key = exchange === 'NSE' ? 'Symbol' : 'ScripId';
        
        // Find matching stock data
        const stockData = Array.isArray(data)
          ? data.filter(item => item[key] === stockName)
          : data[key] === stockName ? [data] : [];
        
        if (stockData.length === 0) {
          outputDiv.innerHTML = `<div class="alert alert-warning">No data found for ${stockName} in ${exchange} on ${formatDisplayDate(date)}</div>`;
          return;
        }
        
        // Display results
        displayResults(stockData, selectedIndicators, stockName, date, exchange);
      } catch (error) {
        outputDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        console.error(error);
      }
    });

    // Format date for display
    function formatDisplayDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-GB', {
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric'
      });
    }

    // Display results in a table
    function displayResults(stockData, indicators, stockName, date, exchange) {
      let html = `
        <div class="card mt-4">
          <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Results for ${stockName} on ${formatDisplayDate(date)} (${exchange})</h4>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-bordered table-striped">
                <thead class="table-dark">
                  <tr>
                    <th>Indicator</th>
                    <th>Value</th>
                  </tr>
                </thead>
                <tbody>
      `;
      
      // Add each selected indicator
     stockData.forEach(stock => {
  indicators.forEach(indicator => {
    const value = stock[indicator] || '-';
    let valueClass = '';
    let displayValue = value;
    
    // Add color coding for values if they are numeric
    if (!isNaN(value)) {
      if (value === '0') {
        valueClass = 'bg-danger text-white';
      } else if (value === '100') {
        valueClass = 'bg-success text-white';
        displayValue = `${value} (Not Applicable)`;
      }
    }
    
    html += `
      <tr>
        <td>${indicator}</td>
        <td class="${valueClass}">${displayValue}</td>
      </tr>
    `;
  });
});
      
      html += `
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      
      outputDiv.innerHTML = html;
    }
  </script>
</body>
</html>
