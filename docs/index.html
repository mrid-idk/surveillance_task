<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stock Surveillance Data Viewer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 2rem; }
    .form-section { margin-bottom: 1.5rem; }
    .indicator-container {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 0.25rem;
      padding: 0.5rem;
    }
    .indicator-item {
      margin-bottom: 0.5rem;
    }
    .loading {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 0.2em solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: spinner-border .75s linear infinite;
      margin-left: 0.5rem;
    }
    @keyframes spinner-border {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4">Stock Surveillance Data Viewer</h2>

    <form id="stockForm">
      <!-- Exchange Selection -->
      <div class="form-section">
        <label for="exchange" class="form-label">Select Exchange</label>
        <select class="form-select" id="exchange" required>
          <option value="">-- Select --</option>
          <option value="NSE">NSE</option>
          <option value="BSE">BSE</option>
        </select>
      </div>

      <!-- Date Picker (Calendar) -->
      <div class="form-section">
        <label for="date" class="form-label">Select Date</label>
        <input type="date" class="form-control" id="date" required>
        <small class="text-muted" id="dateAvailability"></small>
      </div>

      <!-- Stock Auto-suggest -->
      <div class="form-section">
        <label for="stock" class="form-label">Stock Name/Symbol</label>
        <input list="stockList" class="form-control" id="stock" placeholder="Type stock name..." required>
        <datalist id="stockList">
          <!-- Populated dynamically -->
        </datalist>
        <small class="text-muted">Available stocks will load after selecting date</small>
      </div>

      <!-- Indicator Selection -->
      <div class="form-section">
        <label class="form-label">Choose Indicators</label>
        <div class="indicator-container" id="indicatorsContainer">
          <div class="text-center p-3">Please select an exchange and date first</div>
        </div>
      </div>

      <!-- Summary -->
      <div class="form-section">
        <label class="form-label">Selected Indicators:</label>
        <div id="summary" class="p-2 bg-light rounded">
          <em>No indicators selected</em>
        </div>
      </div>

      <!-- Submit -->
      <button type="submit" class="btn btn-primary">View Data</button>
    </form>

    <!-- Output -->
    <div id="output" class="mt-4"></div>
  </div>

  <script>
    // Global state
    const state = {
      indexFiles: {
        nse: [],
        bse: []
      },
      stocks: [],
      indicators: [],
      dateFileMap: {},
      availableDates: new Set()
    };

    // DOM elements
    const exchangeSelect = document.getElementById('exchange');
    const dateSelect = document.getElementById('date');
    const stockInput = document.getElementById('stock');
    const stockList = document.getElementById('stockList');
    const indicatorsContainer = document.getElementById('indicatorsContainer');
    const summaryDiv = document.getElementById('summary');
    const outputDiv = document.getElementById('output');
    const form = document.getElementById('stockForm');

    // Load index files when exchange is selected
    exchangeSelect.addEventListener('change', async () => {
      const exchange = exchangeSelect.value.toLowerCase();
      if (!exchange) return;
      
      dateSelect.innerHTML = '<option value="">-- Loading dates... --</option>';
      
      try {
        // Load index file based on exchange
        const indexFileName = exchange === 'nse' ? 'nse_json/index.json' : 'bse_json/index.json';
        const response = await fetch(indexFileName);
        
        if (!response.ok) {
          throw new Error(`Failed to load index file for ${exchange.toUpperCase()}`);
        }
        
        const indexData = await response.json();
        state.indexFiles[exchange] = indexData;
        
        // Extract and format dates
        populateDates(exchange, indexData);
      } catch (error) {
        dateSelect.innerHTML = '<option value="">-- Error loading dates --</option>';
        console.error(error);
      }
    });

    // Extract dates from filenames and populate date dropdown
    function populateDates(exchange, indexFiles) {
      dateSelect.innerHTML = '<option value="">-- Select Date --</option>';
      
      indexFiles.forEach(filePath => {
        // Extract date from filename (IND150525.json â†’ 15/05/25)
        const match = filePath.match(/IND(\d{2})(\d{2})(\d{2})\.json/);
        if (match) {
          const day = match[1];
          const month = match[2];
          const year = `20${match[3]}`;
          const dateStr = `${year}-${month}-${day}`;
          const displayDate = `${day}/${month}/${year}`;
          
          // Store mapping of formatted date to filename
          state.dateFileMap[dateStr] = filePath;
          
          const option = document.createElement('option');
          option.value = dateStr;
          option.textContent = displayDate;
          dateSelect.appendChild(option);
        }
      });
    }

    // Load stocks and indicators when date is selected
    dateSelect.addEventListener('change', async () => {
      const date = dateSelect.value;
      const exchange = exchangeSelect.value.toLowerCase();
      
      if (!date || !exchange) return;
      
      stockInput.value = '';
      indicatorsContainer.innerHTML = '<div class="text-center p-3">Loading indicators...</div>';
      
      try {
        const filePath = state.dateFileMap[date];
        if (!filePath) throw new Error('File path not found for selected date');
        
        const response = await fetch(filePath);
        if (!response.ok) throw new Error('Failed to load data file');
        
        const data = await response.json();
        
        // Extract stocks and indicators
        loadStocksAndIndicators(exchange, data);
      } catch (error) {
        indicatorsContainer.innerHTML = `<div class="text-danger p-3">Error: ${error.message}</div>`;
        console.error(error);
      }
    });

    // Load stocks and indicators from data
    function loadStocksAndIndicators(exchange, data) {
      stockList.innerHTML = '';
      state.stocks = [];
      
      // Get stock symbols from data
      if (Array.isArray(data)) {
        const key = exchange === 'nse' ? 'Symbol' : 'ScripId';
        
        // Extract unique stock symbols
        const stockSet = new Set(data.map(item => item[key]).filter(Boolean));
        state.stocks = Array.from(stockSet);
        
        // Get indicators from first item
        if (data.length > 0) {
          loadIndicators(data[0]);
        }
      } else {
        // Single item in data
        const key = exchange === 'nse' ? 'Symbol' : 'ScripId';
        if (data[key]) {
          state.stocks.push(data[key]);
        }
        loadIndicators(data);
      }
      
      // Populate stock suggestions
      state.stocks.sort().forEach(stock => {
        const option = document.createElement('option');
        option.value = stock;
        stockList.appendChild(option);
      });
    }

    // Load indicators as checkboxes
    function loadIndicators(sampleData) {
      indicatorsContainer.innerHTML = '';
      
      // Find indicator fields (most start after "GSM")
      const startIndex = Object.keys(sampleData).indexOf('GSM');
      if (startIndex === -1) {
        indicatorsContainer.innerHTML = '<div class="text-danger p-3">No indicators found in data</div>';
        return;
      }
      
      const fields = Object.keys(sampleData);
      state.indicators = fields.slice(startIndex);
      
      // Create checkboxes for indicators
      state.indicators.forEach(indicator => {
        if (indicator === '' || indicator.startsWith('Filler')) return;
        
        const div = document.createElement('div');
        div.className = 'indicator-item';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-check-input me-2';
        checkbox.id = `ind-${indicator}`;
        checkbox.value = indicator;
        checkbox.name = 'indicators';
        
        const label = document.createElement('label');
        label.className = 'form-check-label';
        label.htmlFor = `ind-${indicator}`;
        label.textContent = indicator;
        
        checkbox.addEventListener('change', updateSummary);
        
        div.appendChild(checkbox);
        div.appendChild(label);
        indicatorsContainer.appendChild(div);
      });
    }

    // Update summary of selected indicators
    function updateSummary() {
      const selectedIndicators = Array.from(
        document.querySelectorAll('input[name="indicators"]:checked')
      ).map(cb => cb.value);
      
      if (selectedIndicators.length === 0) {
        summaryDiv.innerHTML = '<em>No indicators selected</em>';
        return;
      }
      
      summaryDiv.innerHTML = '';
      selectedIndicators.forEach(ind => {
        const badge = document.createElement('span');
        badge.className = 'badge bg-primary me-2 mb-2';
        badge.textContent = ind;
        summaryDiv.appendChild(badge);
      });
    }

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const exchange = exchangeSelect.value;
      const date = dateSelect.value;
      const stockName = stockInput.value.trim();
      const selectedIndicators = Array.from(
        document.querySelectorAll('input[name="indicators"]:checked')
      ).map(cb => cb.value);
      
      if (!exchange || !date || !stockName || selectedIndicators.length === 0) {
        outputDiv.innerHTML = '<div class="alert alert-warning">Please fill all fields and select at least one indicator</div>';
        return;
      }
      
      // Check if selected date has data
      if (!state.dateFileMap[date]) {
        outputDiv.innerHTML = '<div class="alert alert-warning">No data available for the selected date</div>';
        return;
      }
      
      outputDiv.innerHTML = '<div class="alert alert-info">Loading data... <span class="loading"></span></div>';
      
      try {
        const filePath = state.dateFileMap[date];
        const response = await fetch(filePath);
        if (!response.ok) throw new Error('Failed to load data file');
        
        const data = await response.json();
        const key = exchange === 'NSE' ? 'Symbol' : 'ScripId';
        
        // Find matching stock data
        const stockData = Array.isArray(data)
          ? data.filter(item => item[key] === stockName)
          : data[key] === stockName ? [data] : [];
        
        if (stockData.length === 0) {
          outputDiv.innerHTML = `<div class="alert alert-warning">No data found for ${stockName} in ${exchange} on ${formatDisplayDate(date)}</div>`;
          return;
        }
        
        // Display results
        displayResults(stockData, selectedIndicators, stockName, date, exchange);
      } catch (error) {
        outputDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        console.error(error);
      }
    });

    // Format date for display
    function formatDisplayDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-GB', {
        day: '2-digit', 
        month: '2-digit', 
        year: 'numeric'
      });
    }

    // Display results in a table
    function displayResults(stockData, indicators, stockName, date, exchange) {
      let html = `
        <div class="card mt-4">
          <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Results for ${stockName} on ${formatDisplayDate(date)} (${exchange})</h4>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-bordered table-striped">
                <thead class="table-dark">
                  <tr>
                    <th>Indicator</th>
                    <th>Value</th>
                  </tr>
                </thead>
                <tbody>
      `;
      
      // Add each selected indicator
      stockData.forEach(stock => {
        indicators.forEach(indicator => {
          const value = stock[indicator] || '-';
          let valueClass = '';
          
          // Add color coding for values if they are numeric
          if (!isNaN(value)) {
            if (value === '0') {
              valueClass = 'bg-danger text-white';
            } else if (value === '100') {
              valueClass = 'bg-success text-white';
            }
          }
          
          html += `
            <tr>
              <td>${indicator}</td>
              <td class="${valueClass}">${value}</td>
            </tr>
          `;
        });
      });
      
      html += `
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      
      outputDiv.innerHTML = html;
    }
  </script>
</body>
</html>
